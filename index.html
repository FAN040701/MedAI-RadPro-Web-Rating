<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>医学报告智能标注工具 - 医生评估版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
    <style>
        .star {
            cursor: pointer;
            color: #d2d6dc;
            transition: color 0.2s, transform 0.1s;
        }
        .star.hover,
        .star.selected {
            color: #f59e0b;
        }
        .star:hover {
            transform: scale(1.1);
        }
        .report-content { white-space: pre-wrap; word-break: break-word; }
        #main-content.hidden { display: none; }
        #upload-container.hidden { display: none; }
        .btn-disabled { opacity: 0.5; cursor: not-allowed; }
        .modal.flex { display: flex; }
        @keyframes flash {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.03); }
        }
        .flash-animation { animation: flash 0.4s ease-out; }
        .highlight {
            background-color: #fde047;
            font-weight: 600;
            padding: 1px 2px;
            margin: -1px -2px;
            border-radius: 4px;
        }
        .suggestion-item {
            cursor: pointer;
            padding: 4px 6px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .suggestion-item:hover { background-color: #e5e7eb; }

        /* 切换按钮样式 */
        .toggle-btn {
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .toggle-btn.active {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        .toggle-btn:not(.active) {
            background-color: #f3f4f6;
            color: #6b7280;
            border-color: #d1d5db;
        }
        .toggle-btn:not(.active):hover {
            background-color: #e5e7eb;
        }

        /* 偏好选择按钮 */
        .pref-btn {
            padding: 8px 20px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.2s;
            border: 2px solid #d1d5db;
            background-color: #f9fafb;
        }
        .pref-btn:hover {
            border-color: #9ca3af;
            background-color: #f3f4f6;
        }
        .pref-btn.selected {
            border-color: #3b82f6;
            background-color: #eff6ff;
            color: #1d4ed8;
        }

        /* 评分区块样式 */
        .rating-section {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 1px solid #bae6fd;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .rating-title {
            font-size: 14px;
            font-weight: 600;
            color: #0369a1;
            margin-bottom: 8px;
        }
        .star-container-small .star {
            font-size: 28px;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div class="container mx-auto max-w-7xl p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">放射科报告智能标注工具</h1>
            <p class="text-gray-600 mt-2">医生评估版 - 比较SFT与DPO模型输出效果</p>
        </header>

        <div id="upload-container" class="text-center py-20 bg-white shadow-xl rounded-2xl border-2 border-dashed border-gray-300 transition-all duration-300">
            <i class="fas fa-cloud-upload-alt text-6xl text-blue-500"></i>
            <h2 class="mt-6 text-xl font-semibold text-gray-700">拖拽文件至此 或 点击上传</h2>
            <p class="text-gray-500 mt-1">请上传医生评估数据JSON文件</p>
            <button id="upload-button" class="mt-6 bg-blue-600 text-white font-bold py-2 px-6 rounded-lg shadow-lg hover:bg-blue-700 transition-all duration-300">
                选择文件
            </button>
            <input type="file" id="file-input" class="hidden" accept=".json">
        </div>

        <main id="main-content" class="hidden bg-white shadow-xl rounded-2xl">
            <div class="p-4 md:p-6 border-b">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-lg font-semibold text-gray-700">浏览进度</h3>
                    <span id="progress-text" class="text-gray-600 font-medium">0 / 0</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                </div>
                <div class="flex justify-between items-center mt-4">
                    <div>
                        <button id="prev-button" class="bg-gray-200 text-gray-700 font-bold py-2 px-5 rounded-lg hover:bg-gray-300 transition-all">
                            <i class="fas fa-arrow-left mr-2"></i>上一个
                        </button>
                        <button id="next-button" class="ml-2 bg-gray-200 text-gray-700 font-bold py-2 px-5 rounded-lg hover:bg-gray-300 transition-all">
                            下一个<i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                    <button id="download-button" class="bg-green-600 text-white font-bold py-2 px-5 rounded-lg shadow-md hover:bg-green-700 transition-all">
                        <i class="fas fa-download mr-2"></i>下载标注结果
                    </button>
                </div>
            </div>

            <div class="p-6 md:p-8">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- 左侧列 -->
                    <div class="space-y-6">
                        <div>
                            <h2 class="text-xl font-semibold text-gray-700 border-b-2 border-blue-500 pb-2 mb-3">原始报告</h2>
                            <div id="original-report" class="report-content bg-gray-100 p-4 rounded-lg h-64 overflow-y-auto text-gray-800 leading-relaxed"></div>
                        </div>
                        <div>
                            <h2 class="text-xl font-semibold text-gray-700 border-b-2 border-blue-500 pb-2 mb-3 flex items-center">
                                缺陷类型 (True Defects)
                                <i id="defect-help-icon" class="fas fa-question-circle text-blue-500 ml-2 cursor-pointer hover:text-blue-700" title="查看缺陷类型解释"></i>
                            </h2>
                            <div id="defect-types" class="flex flex-wrap gap-2"></div>
                        </div>
                        <div>
                            <div class="flex items-center justify-between border-b-2 border-blue-500 pb-2 mb-3">
                                <h2 class="text-xl font-semibold text-gray-700">修改意见</h2>
                                <!-- 模型切换按钮 -->
                                <div class="flex gap-2" id="model-toggle-suggestions">
                                    <button class="toggle-btn active" data-model="sft">微调</button>
                                    <button class="toggle-btn" data-model="dpo">RadPro</button>
                                </div>
                            </div>
                            <div id="suggestions" class="report-content bg-gray-100 p-4 rounded-lg h-48 overflow-y-auto text-gray-800 leading-relaxed"></div>
                        </div>
                    </div>

                    <!-- 右侧列 -->
                    <div class="space-y-6">
                        <div>
                            <div class="flex items-center justify-between border-b-2 border-green-500 pb-2 mb-3">
                                <h2 class="text-xl font-semibold text-gray-700">改进后的报告</h2>
                                <!-- 模型切换按钮 -->
                                <div class="flex gap-2" id="model-toggle-improved">
                                    <button class="toggle-btn active" data-model="sft">微调</button>
                                    <button class="toggle-btn" data-model="dpo">RadPro</button>
                                </div>
                            </div>
                            <div id="improved-report" class="report-content bg-green-50 p-4 rounded-lg h-72 overflow-y-auto text-gray-800 border border-green-200"></div>
                        </div>

                        <!-- 评分区域 -->
                        <div id="rating-component" class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                            <h2 class="text-xl font-semibold text-gray-700 text-center mb-4 flex items-center justify-center">
                                医生评分
                                <i id="rating-help-icon" class="fas fa-question-circle text-blue-500 ml-2 cursor-pointer hover:text-blue-700" title="查看评分标准说明"></i>
                            </h2>

                            <!-- Safety 评分 -->
                            <div class="rating-section">
                                <div class="rating-title">
                                    <i class="fas fa-shield-alt mr-1"></i>Safety (安全性 - Attending医生视角)
                                </div>
                                <div class="flex justify-center items-center star-container-small" data-rating-type="safety">
                                    <span class="star" data-value="1">&#9733;</span>
                                    <span class="star" data-value="2">&#9733;</span>
                                    <span class="star" data-value="3">&#9733;</span>
                                    <span class="star" data-value="4">&#9733;</span>
                                    <span class="star" data-value="5">&#9733;</span>
                                </div>
                                <p class="text-center text-sm text-gray-500 mt-1" id="safety-feedback"></p>
                            </div>

                            <!-- Edu-Value 评分 -->
                            <div class="rating-section">
                                <div class="rating-title">
                                    <i class="fas fa-graduation-cap mr-1"></i>Edu-Value (教育价值 - Resident医生视角)
                                </div>
                                <div class="flex justify-center items-center star-container-small" data-rating-type="edu_value">
                                    <span class="star" data-value="1">&#9733;</span>
                                    <span class="star" data-value="2">&#9733;</span>
                                    <span class="star" data-value="3">&#9733;</span>
                                    <span class="star" data-value="4">&#9733;</span>
                                    <span class="star" data-value="5">&#9733;</span>
                                </div>
                                <p class="text-center text-sm text-gray-500 mt-1" id="edu_value-feedback"></p>
                            </div>

                            <!-- Pref vs SFT -->
                            <div class="rating-section">
                                <div class="rating-title">
                                    <i class="fas fa-balance-scale mr-1"></i>Pref vs 微调 (RadPro输出相比微调输出)
                                </div>
                                <div class="flex justify-center gap-3" id="pref-vs-sft-container">
                                    <button class="pref-btn" data-value="dpo">RadPro更好</button>
                                    <button class="pref-btn" data-value="tie">相当</button>
                                    <button class="pref-btn" data-value="sft">微调更好</button>
                                </div>
                            </div>

                            <!-- Pref vs Base -->
                            <div class="rating-section">
                                <div class="rating-title">
                                    <i class="fas fa-balance-scale-left mr-1"></i>Pref vs Base (RadPro输出相比原始报告)
                                </div>
                                <div class="flex justify-center gap-3" id="pref-vs-base-container">
                                    <button class="pref-btn" data-value="dpo">RadPro更好</button>
                                    <button class="pref-btn" data-value="tie">相当</button>
                                    <button class="pref-btn" data-value="base">原始更好</button>
                                </div>
                            </div>

                            <!-- 综合评分 -->
                            <div class="rating-section" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-color: #fbbf24;">
                                <div class="rating-title" style="color: #b45309;">
                                    <i class="fas fa-star mr-1"></i>综合评分 (Overall)
                                </div>
                                <div class="flex justify-center items-center star-container-small" data-rating-type="overall">
                                    <span class="star" data-value="1">&#9733;</span>
                                    <span class="star" data-value="2">&#9733;</span>
                                    <span class="star" data-value="3">&#9733;</span>
                                    <span class="star" data-value="4">&#9733;</span>
                                    <span class="star" data-value="5">&#9733;</span>
                                </div>
                                <p class="text-center text-sm text-gray-500 mt-1" id="overall-feedback"></p>
                            </div>

                            <!-- 评论 -->
                            <textarea id="comment-textarea" class="mt-4 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-300 focus:border-blue-500 transition" rows="3" placeholder="请输入您的评论或建议... (可选)"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 缺陷类型帮助模态框 -->
    <div id="defect-help-modal" class="modal fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50 transition-opacity duration-300">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[80vh] flex flex-col">
            <div class="p-5 border-b flex justify-between items-center sticky top-0 bg-white">
                <h2 class="text-2xl font-bold text-gray-800">缺陷类型详细解释</h2>
                <button id="close-defect-modal-button" class="text-gray-400 hover:text-gray-800 text-3xl font-light leading-none">&times;</button>
            </div>
            <div class="p-6 space-y-4 overflow-y-auto" id="defect-modal-content-body"></div>
        </div>
    </div>

    <!-- 评分帮助模态框 -->
    <div id="rating-help-modal" class="modal fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50 transition-opacity duration-300">
        <div class="bg-white rounded-lg shadow-xl max-w-lg w-full max-h-[80vh] flex flex-col">
            <div class="p-5 border-b flex justify-between items-center sticky top-0 bg-white">
                <h2 class="text-2xl font-bold text-gray-800">评分标准说明</h2>
                <button id="close-rating-modal-button" class="text-gray-400 hover:text-gray-800 text-3xl font-light leading-none">&times;</button>
            </div>
            <div class="p-6 space-y-4 overflow-y-auto" id="rating-modal-content-body"></div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- 元素获取 ---
        const uploadContainer = document.getElementById('upload-container');
        const mainContent = document.getElementById('main-content');
        const uploadButton = document.getElementById('upload-button');
        const fileInput = document.getElementById('file-input');
        const prevButton = document.getElementById('prev-button');
        const nextButton = document.getElementById('next-button');
        const downloadButton = document.getElementById('download-button');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const originalReportEl = document.getElementById('original-report');
        const defectTypesEl = document.getElementById('defect-types');
        const suggestionsEl = document.getElementById('suggestions');
        const improvedReportEl = document.getElementById('improved-report');
        const commentTextarea = document.getElementById('comment-textarea');
        const defectHelpIcon = document.getElementById('defect-help-icon');
        const defectHelpModal = document.getElementById('defect-help-modal');
        const closeDefectModalButton = document.getElementById('close-defect-modal-button');
        const defectModalContentBody = document.getElementById('defect-modal-content-body');
        const ratingHelpIcon = document.getElementById('rating-help-icon');
        const ratingHelpModal = document.getElementById('rating-help-modal');
        const closeRatingModalButton = document.getElementById('close-rating-modal-button');
        const ratingModalContentBody = document.getElementById('rating-modal-content-body');

        // 模型切换按钮
        const modelToggleSuggestions = document.getElementById('model-toggle-suggestions');
        const modelToggleImproved = document.getElementById('model-toggle-improved');

        // 偏好选择按钮
        const prefVsSftContainer = document.getElementById('pref-vs-sft-container');
        const prefVsBaseContainer = document.getElementById('pref-vs-base-container');

        // --- 状态管理 ---
        let allReportsData = [];
        let originalJsonData = {};
        let currentIndex = 0;
        let currentModel = 'sft';  // 当前显示的模型 ('sft' or 'dpo')

        const feedbackMessages = {
            1: '效果不佳',
            2: '效果有限',
            3: '有一定改进',
            4: '效果较好',
            5: '显著成效'
        };

        const defectExplanations = {
            "A. 描述性错误": {
                "A1_positive_findings_description_omission": "阳性发现描述遗漏",
                "A2_missing_systematic_description": "系统性描述遗漏",
                "A3_brief_key_descriptors": "关键描述过于简略",
                "A4_measurement_errors": "测量错误或缺失",
                "A5_vague_terminology": "术语模糊或非标准化",
                "A6_inadequate_technique": "检查技术描述不充分",
                "A7_inadequate_lesions": "病灶描述不充分"
            },
            "B. 分析性错误": {
                "B1_inconsistent_impression": "诊断意见与影像所见不符",
                "B2_missing_key_findings": "关键发现未总结",
                "B3_Discrepancy_in_location": "位置描述不一致",
                "B4_lack_synthesis": "缺乏综合分析",
                "B5_vague_recommendations": "建议不明确"
            },
            "C. 语言性错误": {
                "C1_grammar_errors": "语法错误",
                "C2_punctuation_errors": "标点符号错误",
                "C3_improper_prioritization": "诊断意见排序不当"
            }
        };

        const ratingExplanations = {
            "Safety (安全性)": "评估改进后报告的临床安全性。5分表示报告完全准确，无任何可能导致误诊的错误；1分表示存在可能影响患者安全的严重错误。",
            "Edu-Value (教育价值)": "评估报告改进建议对住院医师的教育价值。5分表示建议专业、详细、有很好的学习价值；1分表示建议模糊或存在误导。",
            "Pref vs 微调": "比较RadPro模型输出与微调模型输出，选择您认为更好的那个，或选择'相当'表示两者差不多。",
            "Pref vs Base": "比较RadPro模型输出与原始报告，选择您认为更好的那个，或选择'相当'表示两者差不多。",
            "Overall (综合评分)": "综合考虑所有因素，对当前样本给出一个整体评价。5分表示改进效果显著；1分表示改进后更差。"
        };

        // --- 功能初始化 ---
        populateDefectHelpModal();
        populateRatingHelpModal();

        // --- 事件监听 ---
        uploadButton.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFileUpload);
        uploadContainer.addEventListener('dragover', (e) => { e.preventDefault(); uploadContainer.classList.add('border-blue-500', 'bg-blue-50'); });
        uploadContainer.addEventListener('dragleave', () => { uploadContainer.classList.remove('border-blue-500', 'bg-blue-50'); });
        uploadContainer.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadContainer.classList.remove('border-blue-500', 'bg-blue-50');
            const files = e.dataTransfer.files;
            if (files.length > 0) { fileInput.files = files; handleFileUpload({ target: fileInput }); }
        });
        prevButton.addEventListener('click', navigateToPrevious);
        nextButton.addEventListener('click', navigateToNext);
        downloadButton.addEventListener('click', downloadResults);

        // 模型切换事件
        modelToggleSuggestions.addEventListener('click', (e) => {
            if (e.target.classList.contains('toggle-btn')) {
                currentModel = e.target.dataset.model;
                updateModelToggleUI();
                updateContentDisplay();
            }
        });
        modelToggleImproved.addEventListener('click', (e) => {
            if (e.target.classList.contains('toggle-btn')) {
                currentModel = e.target.dataset.model;
                updateModelToggleUI();
                updateContentDisplay();
            }
        });

        // 星级评分事件
        document.querySelectorAll('.star-container-small').forEach(container => {
            const ratingType = container.dataset.ratingType;
            const stars = container.querySelectorAll('.star');

            container.addEventListener('mouseleave', () => {
                const savedRating = allReportsData[currentIndex]?.ratings?.[ratingType];
                updateStarsUI(container, savedRating);
                updateFeedback(ratingType, savedRating);
            });

            stars.forEach(star => {
                star.addEventListener('mouseover', () => {
                    const hoverValue = parseInt(star.dataset.value, 10);
                    updateStarsUI(container, hoverValue, true);
                    updateFeedback(ratingType, hoverValue);
                });
                star.addEventListener('click', () => {
                    const rating = parseInt(star.dataset.value, 10);
                    saveRating(ratingType, rating);
                    updateStarsUI(container, rating);
                    updateFeedback(ratingType, rating);
                });
            });
        });

        // 偏好选择事件
        prefVsSftContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('pref-btn')) {
                const value = e.target.dataset.value;
                saveRating('pref_vs_sft', value);
                updatePrefButtonsUI(prefVsSftContainer, value);
            }
        });
        prefVsBaseContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('pref-btn')) {
                const value = e.target.dataset.value;
                saveRating('pref_vs_base', value);
                updatePrefButtonsUI(prefVsBaseContainer, value);
            }
        });

        defectHelpIcon.addEventListener('click', () => openModal(defectHelpModal));
        closeDefectModalButton.addEventListener('click', () => closeModal(defectHelpModal));
        defectHelpModal.addEventListener('click', (e) => { if (e.target === defectHelpModal) closeModal(defectHelpModal); });
        ratingHelpIcon.addEventListener('click', () => openModal(ratingHelpModal));
        closeRatingModalButton.addEventListener('click', () => closeModal(ratingHelpModal));
        ratingHelpModal.addEventListener('click', (e) => { if (e.target === ratingHelpModal) closeModal(ratingHelpModal); });

        // --- 函数定义 ---
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file || file.type !== 'application/json') { alert('请上传有效的JSON文件。'); return; }
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!data.detailed_results || !Array.isArray(data.detailed_results)) {
                        throw new Error('JSON文件格式不正确，缺少 "detailed_results" 数组。');
                    }
                    originalJsonData = data;
                    // 初始化评分数据
                    allReportsData = data.detailed_results.map(item => ({
                        ...item,
                        ratings: item.ratings || {
                            safety: null,
                            edu_value: null,
                            pref_vs_sft: null,
                            pref_vs_base: null,
                            overall: null
                        },
                        comment: item.comment || ""
                    }));
                    currentIndex = 0;
                    currentModel = 'sft';
                    startAnnotation();
                } catch (error) {
                    alert(`解析JSON文件失败: ${error.message}`);
                }
            };
            reader.readAsText(file);
        }

        function startAnnotation() {
            uploadContainer.classList.add('hidden');
            mainContent.classList.remove('hidden');
            renderCurrentReport();
        }

        function renderCurrentReport() {
            if (allReportsData.length === 0) return;
            const report = allReportsData[currentIndex];

            // 显示原始报告
            originalReportEl.textContent = report.original_report || '无内容';

            // 显示缺陷类型
            defectTypesEl.innerHTML = '';
            if (report.true_defects && Array.isArray(report.true_defects)) {
                report.true_defects.forEach(defect => {
                    const span = document.createElement('span');
                    span.className = 'bg-red-100 text-red-800 text-sm font-medium mr-2 px-2.5 py-0.5 rounded-full';
                    span.textContent = defect;
                    defectTypesEl.appendChild(span);
                });
            }

            // 更新内容显示
            updateModelToggleUI();
            updateContentDisplay();

            // 更新进度和导航
            updateProgressBar();
            updateNavigationButtons();

            // 恢复评分状态
            restoreRatingsUI(report);

            // 恢复评论
            commentTextarea.value = report.comment || '';
        }

        function updateModelToggleUI() {
            // 更新两个切换按钮组的UI
            [modelToggleSuggestions, modelToggleImproved].forEach(container => {
                container.querySelectorAll('.toggle-btn').forEach(btn => {
                    if (btn.dataset.model === currentModel) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
            });
        }

        function updateContentDisplay() {
            if (allReportsData.length === 0) return;
            const report = allReportsData[currentIndex];

            // 根据当前选择的模型显示内容
            const outputData = currentModel === 'sft' ? report.sft_output : report.dpo_output;

            if (outputData) {
                suggestionsEl.textContent = outputData.suggestions || '未找到修改意见';
                improvedReportEl.textContent = outputData.improved_report || '未找到改进后的报告';
            } else {
                suggestionsEl.textContent = '无数据';
                improvedReportEl.textContent = '无数据';
            }
        }

        function restoreRatingsUI(report) {
            const ratings = report.ratings || {};

            // 恢复星级评分
            ['safety', 'edu_value', 'overall'].forEach(type => {
                const container = document.querySelector(`[data-rating-type="${type}"]`);
                if (container) {
                    updateStarsUI(container, ratings[type]);
                    updateFeedback(type, ratings[type]);
                }
            });

            // 恢复偏好选择
            updatePrefButtonsUI(prefVsSftContainer, ratings.pref_vs_sft);
            updatePrefButtonsUI(prefVsBaseContainer, ratings.pref_vs_base);
        }

        function updateStarsUI(container, rating, isHover = false) {
            const stars = container.querySelectorAll('.star');
            stars.forEach(star => {
                const starValue = parseInt(star.dataset.value, 10);
                const shouldBeLit = starValue <= rating;
                star.classList.toggle(isHover ? 'hover' : 'selected', shouldBeLit);
                if (!isHover) star.classList.remove('hover');
            });
        }

        function updateFeedback(ratingType, value) {
            const feedbackEl = document.getElementById(`${ratingType}-feedback`);
            if (feedbackEl) {
                feedbackEl.textContent = value ? feedbackMessages[value] : '';
            }
        }

        function updatePrefButtonsUI(container, selectedValue) {
            container.querySelectorAll('.pref-btn').forEach(btn => {
                if (btn.dataset.value === selectedValue) {
                    btn.classList.add('selected');
                } else {
                    btn.classList.remove('selected');
                }
            });
        }

        function saveRating(ratingType, value) {
            if (allReportsData.length > 0) {
                if (!allReportsData[currentIndex].ratings) {
                    allReportsData[currentIndex].ratings = {};
                }
                allReportsData[currentIndex].ratings[ratingType] = value;
            }
        }

        function saveCurrentData() {
            if (allReportsData.length > 0) {
                allReportsData[currentIndex].comment = commentTextarea.value.trim();
            }
        }

        function updateProgressBar() {
            const total = allReportsData.length;
            if (total === 0) {
                progressText.textContent = `0 / 0`;
                progressBar.style.width = '0%';
                return;
            }
            const currentPosition = currentIndex + 1;
            const percentage = (currentPosition / total) * 100;
            progressBar.style.width = `${percentage}%`;
            progressText.textContent = `${currentPosition} / ${total}`;
        }

        function updateNavigationButtons() {
            prevButton.disabled = currentIndex === 0;
            nextButton.disabled = currentIndex === allReportsData.length - 1;
            prevButton.classList.toggle('btn-disabled', prevButton.disabled);
            nextButton.classList.toggle('btn-disabled', nextButton.disabled);
        }

        function navigateToPrevious() {
            if (currentIndex > 0) {
                saveCurrentData();
                currentIndex--;
                currentModel = 'sft';  // 切换样本时重置为SFT
                renderCurrentReport();
            }
        }

        function navigateToNext() {
            if (currentIndex < allReportsData.length - 1) {
                saveCurrentData();
                currentIndex++;
                currentModel = 'sft';  // 切换样本时重置为SFT
                renderCurrentReport();
            }
        }

        function downloadResults() {
            if (allReportsData.length === 0) { alert('没有可下载的数据。'); return; }
            saveCurrentData();
            const finalData = { ...originalJsonData };
            finalData.detailed_results = allReportsData;
            const dataStr = JSON.stringify(finalData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'doctor_evaluation_results.json';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function populateDefectHelpModal() {
            let html = '';
            for (const category in defectExplanations) {
                html += `<h3 class="text-lg font-semibold text-gray-700 mt-3 first:mt-0 border-b pb-1">${category}</h3><dl class="mt-2">`;
                for (const code in defectExplanations[category]) {
                    html += `<dt class="font-bold text-gray-900">${code}</dt><dd class="ml-4 mb-2 text-gray-600">${defectExplanations[category][code]}</dd>`;
                }
                html += '</dl>';
            }
            defectModalContentBody.innerHTML = html;
        }

        function populateRatingHelpModal() {
            let html = '<dl class="space-y-4">';
            for (const title in ratingExplanations) {
                html += `<div class="p-3 bg-gray-50 rounded-lg"><dt class="font-bold text-gray-900 mb-1">${title}</dt><dd class="text-gray-600 text-sm">${ratingExplanations[title]}</dd></div>`;
            }
            html += '</dl>';
            ratingModalContentBody.innerHTML = html;
        }

        function openModal(modal) { modal.classList.remove('hidden'); modal.classList.add('flex'); }
        function closeModal(modal) { modal.classList.add('hidden'); modal.classList.remove('flex'); }
    });
    </script>
</body>
</html>
